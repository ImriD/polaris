---
phase: 01-jetson-provisioning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements: [PROV-01, PROV-02, PROV-03]

must_haves:
  truths:
    - "ros2 topic list runs without error on the Jetson"
    - "rustc --version reports 1.75+ on the Jetson"
    - "libclang-dev, cmake, pkg-config, libudev-dev are installed"
  artifacts: []
  key_links:
    - from: "/opt/ros/humble/setup.bash"
      to: "ros2 CLI"
      via: "source in shell"
      pattern: "source /opt/ros/humble/setup.bash"
    - from: "~/.cargo/env"
      to: "rustc/cargo"
      via: "source in shell"
      pattern: "source.*cargo/env"
---

<objective>
Install ROS2 Humble, Rust toolchain, and build dependencies on the Jetson.

Purpose: The Jetson is a fresh machine — nothing needed for building polaris crates exists yet. This plan installs the three foundations: ROS2 middleware, Rust compiler, and native C build deps.
Output: A Jetson where `ros2 topic list`, `rustc --version`, and `dpkg -l libclang-dev` all succeed.
</objective>

<execution_context>
@/Users/imridromi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/imridromi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-jetson-provisioning/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ROS2 Humble and build dependencies on Jetson</name>
  <files></files>
  <action>
All commands run on the Jetson via SSH: `sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "command"`

For long-running apt commands, use a generous timeout (up to 10 minutes per command).

Step 1 — Locale setup:
```
sudo apt update && sudo apt install -y locales software-properties-common curl
sudo locale-gen en_US en_US.UTF-8
sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
sudo add-apt-repository -y universe
```

Step 2 — Add ROS2 apt source (new method via .deb package):
```
export ROS_APT_SOURCE_VERSION=$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest | grep -F "tag_name" | awk -F\" '{print $4}')
curl -L -o /tmp/ros2-apt-source.deb "https://github.com/ros-infrastructure/ros-apt-source/releases/download/${ROS_APT_SOURCE_VERSION}/ros2-apt-source_${ROS_APT_SOURCE_VERSION}.$(. /etc/os-release && echo ${UBUNTU_CODENAME:-${VERSION_CODENAME}})_all.deb"
sudo dpkg -i /tmp/ros2-apt-source.deb
sudo apt update
```

Step 3 — Install ROS2 Humble + build deps:
```
sudo apt install -y ros-humble-ros-base ros-dev-tools
sudo apt install -y libclang-dev cmake pkg-config libudev-dev build-essential
```

IMPORTANT: Use `ros-humble-ros-base`, NOT `ros-humble-desktop`. Desktop pulls libopencv-dev which conflicts with JetPack's pre-installed OpenCV.

If the ROS2 apt source .deb download fails (e.g. GitHub API rate limit), fall back to manually adding the ROS2 apt key and source:
```
sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
sudo apt update
```
  </action>
  <verify>
Run these on the Jetson via SSH:
```
sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source /opt/ros/humble/setup.bash && ros2 topic list"
```
Should output `/parameter_events` and `/rosout` without error.

```
sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "dpkg -l libclang-dev cmake pkg-config libudev-dev build-essential | grep '^ii'"
```
Should show all five packages installed.
  </verify>
  <done>ROS2 Humble ros-base is installed, sourcing setup.bash works, ros2 CLI functional, all build deps present.</done>
</task>

<task type="auto">
  <name>Task 2: Install Rust toolchain via rustup on Jetson</name>
  <files></files>
  <action>
All commands run on the Jetson via SSH: `sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "command"`

Step 1 — Install rustup with stable toolchain (non-interactive):
```
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain stable -y
```

Step 2 — Verify:
```
source ~/.cargo/env && rustc --version
```
Must report 1.75+ (current stable is 1.84+).

The `-y` flag makes the installer non-interactive. It auto-detects aarch64-unknown-linux-gnu target.
  </action>
  <verify>
```
sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source ~/.cargo/env && rustc --version && cargo --version"
```
rustc version must be >= 1.75. cargo must be present.
  </verify>
  <done>Rust stable toolchain installed via rustup, rustc 1.75+ confirmed, cargo available.</done>
</task>

</tasks>

<verification>
All three checks must pass from the Mac via SSH:

1. `sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source /opt/ros/humble/setup.bash && ros2 topic list"` — returns topic list
2. `sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source ~/.cargo/env && rustc --version"` — reports 1.75+
3. `sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "dpkg -l libclang-dev | grep '^ii'"` — shows installed
</verification>

<success_criteria>
- ros2 topic list works on the Jetson
- rustc --version shows 1.75+
- libclang-dev, cmake, pkg-config, libudev-dev, build-essential all installed
</success_criteria>

<output>
After completion, create `.planning/phases/01-jetson-provisioning/01-01-SUMMARY.md`
</output>
