---
phase: 01-jetson-provisioning
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified: []
autonomous: true
requirements: [PROV-04, PROV-05]

must_haves:
  truths:
    - "polaris_msgs is built and sourceable from ~/ros2_ws/install/setup.bash"
    - "cargo build --release succeeds for polaris_bridge, polaris_operator, polaris_control"
    - "ros2 topic echo /input/steering receives messages from a running polaris node"
  artifacts:
    - path: "~/ros2_ws/install/polaris_msgs"
      provides: "Compiled polaris_msgs ROS2 package with VehicleState message"
    - path: "~/polaris/target/release/polaris_bridge"
      provides: "Compiled polaris_bridge binary"
  key_links:
    - from: "~/ros2_ws/install/setup.bash"
      to: "cargo build"
      via: "r2r build.rs reads ament environment"
      pattern: "source.*ros2_ws/install/setup.bash"
    - from: "polaris_msgs/msg/VehicleState.msg"
      to: "r2r::polaris_msgs::msg::VehicleState"
      via: "colcon build generates C introspection, r2r bindgen reads it"
      pattern: "colcon build.*polaris_msgs"
---

<objective>
Sync polaris source to the Jetson, build polaris_msgs in a colcon workspace, and compile all polaris Rust crates.

Purpose: With ROS2 and Rust installed (plan 01), this plan gets the actual project code building. polaris_msgs must be built first (colcon) because r2r reads the generated C introspection code at Rust compile time.
Output: Working binaries in ~/polaris/target/release/ and a sourced polaris_msgs package.
</objective>

<execution_context>
@/Users/imridromi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/imridromi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-jetson-provisioning/01-RESEARCH.md
@.planning/phases/01-jetson-provisioning/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync polaris source and build polaris_msgs on Jetson</name>
  <files></files>
  <action>
All commands run from the Mac. SSH target: `sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "command"`

Step 1 — Create directories on Jetson:
```
sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "mkdir -p ~/polaris ~/ros2_ws/src"
```

Step 2 — Sync the polaris workspace to the Jetson using scp:
```
sshpass -p 'nvidia' scp -r \
  Cargo.toml Cargo.lock \
  .cargo \
  polaris_bridge polaris_control polaris_operator polaris_sim polaris_wheel polaris_msgs \
  nvidia@192.168.88.175:~/polaris/
```
Run this from the polaris project root directory. The `.cargo/config.toml` with IDL_PACKAGE_FILTER MUST be included — without it, r2r tries to compile bindings for every ROS2 message package and the build takes forever.

Note: polaris_wheel and polaris_sim are included because they're workspace members in Cargo.toml. Cargo needs all workspace members present even if we only build specific crates.

Step 3 — Copy polaris_msgs into colcon workspace and build:
```
sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "cp -r ~/polaris/polaris_msgs ~/ros2_ws/src/ && source /opt/ros/humble/setup.bash && cd ~/ros2_ws && colcon build --packages-select polaris_msgs"
```

Step 4 — Verify polaris_msgs is built:
```
sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source /opt/ros/humble/setup.bash && source ~/ros2_ws/install/setup.bash && ros2 interface show polaris_msgs/msg/VehicleState"
```
Should print the VehicleState message definition.
  </action>
  <verify>
```
sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source /opt/ros/humble/setup.bash && source ~/ros2_ws/install/setup.bash && ros2 interface show polaris_msgs/msg/VehicleState"
```
Must output the VehicleState message fields (not an error).
  </verify>
  <done>polaris_msgs is built in ~/ros2_ws and ros2 interface show displays the message definition.</done>
</task>

<task type="auto">
  <name>Task 2: Cargo build all polaris crates on Jetson</name>
  <files></files>
  <action>
All commands run via SSH from Mac.

Step 1 — Build polaris_bridge (the core crate, most likely to surface linking issues):
```
sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source /opt/ros/humble/setup.bash && source ~/ros2_ws/install/setup.bash && source ~/.cargo/env && cd ~/polaris && cargo build --release -p polaris_bridge 2>&1 | tail -20"
```
This will take several minutes on first build (r2r bindgen + full compilation). Use a 10-minute timeout.

CRITICAL: Both ROS2 setups MUST be sourced in the same shell as cargo build. r2r's build.rs reads ament environment variables to find ROS2 libraries and message packages. Without this, the build will fail with "cannot find type VehicleState".

Step 2 — Build remaining crates:
```
sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source /opt/ros/humble/setup.bash && source ~/ros2_ws/install/setup.bash && source ~/.cargo/env && cd ~/polaris && cargo build --release -p polaris_control -p polaris_operator 2>&1 | tail -20"
```

If polaris_wheel fails to build due to SDL2 (it's a Mac binary), that's expected and fine — it's not in PROV-05 scope.

If any build fails with missing headers or libraries, check:
- libclang-dev not installed → `sudo apt install libclang-dev`
- r2r can't find ROS2 → both setups not sourced → re-source
- polaris_msgs not found → `source ~/ros2_ws/install/setup.bash` missing
  </action>
  <verify>
```
sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "ls -la ~/polaris/target/release/polaris_bridge ~/polaris/target/release/polaris_control ~/polaris/target/release/polaris_operator"
```
All three binaries must exist.

Optional but useful — quick smoke test that polaris_bridge starts (it will exit or error since no Pixhawk is connected, but the binary should load ROS2 libraries):
```
sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source /opt/ros/humble/setup.bash && source ~/ros2_ws/install/setup.bash && timeout 3 ~/polaris/target/release/polaris_bridge 2>&1 || true"
```
Should load without `librcl_action.so: cannot open shared object file` errors.
  </verify>
  <done>polaris_bridge, polaris_control, and polaris_operator binaries exist in ~/polaris/target/release/ and were built successfully.</done>
</task>

</tasks>

<verification>
All checks must pass from the Mac via SSH:

1. `sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source /opt/ros/humble/setup.bash && source ~/ros2_ws/install/setup.bash && ros2 interface show polaris_msgs/msg/VehicleState"` — prints message definition
2. `sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "ls ~/polaris/target/release/polaris_bridge ~/polaris/target/release/polaris_control ~/polaris/target/release/polaris_operator"` — all three exist
3. `sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source /opt/ros/humble/setup.bash && source ~/ros2_ws/install/setup.bash && timeout 5 ~/polaris/target/release/polaris_control &" && sleep 2 && sshpass -p 'nvidia' ssh nvidia@192.168.88.175 "source /opt/ros/humble/setup.bash && ros2 topic list"` — /input/steering appears in topic list (verifying success criterion 4 from roadmap)
</verification>

<success_criteria>
- polaris_msgs built and visible via `ros2 interface show`
- polaris_bridge, polaris_control, polaris_operator all compile successfully
- At least one node runs and publishes topics visible to `ros2 topic list`
</success_criteria>

<output>
After completion, create `.planning/phases/01-jetson-provisioning/01-02-SUMMARY.md`
</output>
